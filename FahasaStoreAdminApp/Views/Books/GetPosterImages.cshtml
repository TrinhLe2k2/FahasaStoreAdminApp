@using FahasaStoreAdminApp.Components
@model IEnumerable<FahasaStoreAPI.Entities.PosterImage>

<div id="poster-images" class="row row-cols-3 g-3">
    <div>
        <form id="posterImageForm" enctype="multipart/form-data" hidden>
            @Html.AntiForgeryToken()
            <div class="form-group">
                <input type="file" name="fileImage" class="form-control" id="fileImage" />
            </div>
            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>
        </form>
        @(await Html.RenderComponentAsync<ImagePreviewComponent>(RenderMode.ServerPrerendered, new { idInputFile = "fileImage" }))
    </div>
    @foreach (var item in Model)
    {
        <div class="image-container">
            <img src="@item.ImageUrl" width="120" height="120" class="object-fit-contain image">
            <div class="overlay">
                <a href="/PosterImages/Delete" IdValue="@item.PosterImageId" onclick="HandlerCRUD(this, event)" class="icon"><i class="bi bi-trash3"></i></a>
            </div>
        </div>
    }
</div>

<script>

    $(document).ready(function () {
        $('#fileImage').on('change', function (event) {
            $('#posterImageForm').submit();
        });
    });

    $(document).ready(function () {

        function GetPosterImages() {
            var element = $("#listPosterImages");
            $.ajax({
                url: '/Books/GetPosterImages/' + @ViewData["BookID"],
                type: 'GET',
                success: function (data) {
                    $(element).html(data);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    var errorMessage = `Error fetching data: ${jqXHR.status} ${jqXHR.statusText}`;
                    if (jqXHR.responseText) {
                        errorMessage += `\nResponse: ${jqXHR.responseText}`;
                    }
                    alert(errorMessage);
                }
            });
        }

        $('#posterImageForm').submit(function (event) {
            event.preventDefault();
            var formData = new FormData(this);
            $.ajax({
                url: '/PosterImages/Create/' + @ViewData["BookID"],
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function (data) {
                    GetPosterImages();
                    // var htmlImg = `
                    //         <div class="image-container">
                    //             <img src="${data.imageUrl}" width="120" height="120" class="object-fit-contain image">
                    //             <div class="overlay">
                    //                 <a href="/PosterImages/Delete" IdValue="${data.imgId}" onclick="HandlerCRUD(this, event)" class="icon"><i class="bi bi-trash3"></i></a>
                    //             </div>
                    //         </div>
                    // `
                    // $("#poster-images").append(htmlImg);
                },
                error: function (xhr, status, error) {
                    console.error("Error uploading image: " + error);
                }
            });
        });
    });
</script>